<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utah REIA â€“ Rehab Estimator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --navy: #0f2340;
    --navy-mid: #1a3a5c;
    --green: #1a7a4a;
    --green-hover: #15693e;
    --green-light: #22c55e;
    --green-bg: #f0fdf4;
    --green-border: #bbf7d0;
    --blue: #1d4ed8;
    --blue-light: #eff6ff;
    --blue-border: #bfdbfe;
    --slate: #475569;
    --slate-light: #94a3b8;
    --border: #e2e8f0;
    --bg: #f8fafc;
    --white: #ffffff;
    --red: #ef4444;
    --red-bg: #fef2f2;

    --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
    --shadow-lg: 0 20px 50px rgba(0,0,0,0.15);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--navy); min-height: 100vh; }

  /* ===== GATE ===== */
  #gateWrap {
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    background: linear-gradient(140deg, #0a1628 0%, var(--navy) 50%, #0e2d4a 100%);
    padding: 20px;
  }
  .gate-card {
    background: var(--white); border-radius: 20px; box-shadow: var(--shadow-lg);
    padding: 48px 40px; width: 100%; max-width: 420px; text-align: center;
  }
  .gate-card img { max-width: 150px; margin-bottom: 28px; }
  .gate-card h1 { font-size: 1.5rem; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
  .gate-card .subtitle { color: var(--slate); font-size: 0.88rem; margin-bottom: 32px; line-height: 1.6; }
  .gate-field { text-align: left; margin-bottom: 16px; }
  .gate-field label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--navy); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.07em; }
  .gate-field input { width: 100%; padding: 12px 16px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: 'DM Sans', sans-serif; outline: none; transition: border-color 0.2s; }
  .gate-field input:focus { border-color: var(--green); }
  .gate-btn { width: 100%; padding: 14px; background: var(--green); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: background 0.2s; margin-top: 8px; }
  .gate-btn:hover { background: var(--green-hover); }
  #gateMessage { margin-top: 12px; font-size: 0.83rem; color: var(--red); min-height: 18px; }
  .gate-footer-note { margin-top: 24px; font-size: 0.78rem; color: var(--slate-light); }

  /* ===== APP SHELL ===== */
  #appWrap { display: none; min-height: 100vh; flex-direction: column; }

  /* ===== TOP NAV ===== */
  .app-nav {
    background: var(--navy); color: white; padding: 0 20px;
    display: flex; align-items: center; justify-content: space-between;
    height: 58px; position: sticky; top: 0; z-index: 200;
    box-shadow: 0 2px 12px rgba(0,0,0,0.25);
  }
  .nav-brand { display: flex; align-items: center; gap: 12px; }
  .nav-brand img { height: 32px; }
  .nav-brand span { font-size: 0.9rem; font-weight: 600; color: #93c5fd; }
  .nav-right { display: flex; align-items: center; gap: 8px; }



  /* ===== AI STATUS BAR ===== */
  #aiStatusBar { display: none; padding: 9px 20px; font-size: 0.82rem; align-items: center; gap: 10px; }
  #aiStatusBar.loading { display: flex; background: var(--blue-light); color: var(--blue); }
  #aiStatusBar.success { display: flex; background: var(--green-bg); color: var(--green); }
  #aiStatusBar.error { display: flex; background: var(--red-bg); color: var(--red); }

  /* ===== SUMMARY STRIP ===== */
  .summary-strip {
    background: var(--white); border-bottom: 1px solid var(--border);
    padding: 14px 20px; display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
  }
  .s-block { display: flex; flex-direction: column; }
  .s-block .sl { font-size: 0.67rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--slate-light); }
  .s-block .sv { font-size: 1.4rem; font-weight: 800; color: var(--navy); font-variant-numeric: tabular-nums; }
  .s-block.grand .sv { color: var(--green); font-size: 1.9rem; }
  .s-sep { width: 1px; height: 36px; background: var(--border); flex-shrink: 0; }
  #reportTitle {
    flex: 1; min-width: 180px; padding: 8px 12px;
    border: 1.5px solid var(--border); border-radius: 7px;
    font-size: 0.92rem; font-family: 'DM Sans', sans-serif; font-weight: 600;
    color: var(--navy); outline: none; transition: border-color 0.2s;
  }
  #reportTitle:focus { border-color: var(--green); }
  #reportTitle::placeholder { font-weight: 400; color: var(--slate-light); }
  .s-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }

  .btn-primary {
    padding: 9px 18px;
    background: linear-gradient(135deg, #059669 0%, #1d4ed8 120%);
    color: white; border: none; border-radius: 7px;
    font-size: 0.82rem; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif;
    display: flex; align-items: center; gap: 7px;
    box-shadow: 0 2px 10px rgba(5,150,105,0.25); transition: all 0.15s;
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(5,150,105,0.35); }
  .btn-primary:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }
  .btn-secondary {
    padding: 8px 14px; border: 1.5px solid var(--border); background: var(--white);
    border-radius: 7px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
    color: var(--slate); font-family: 'DM Sans', sans-serif; transition: all 0.15s;
    display: flex; align-items: center; gap: 5px;
  }
  .btn-secondary:hover { border-color: var(--slate); }
  .btn-danger { color: var(--red); border-color: #fecaca; }
  .btn-danger:hover { background: var(--red-bg); border-color: var(--red); }

  /* ===== TAB BAR ===== */
  .tab-bar {
    background: var(--white); border-bottom: 1px solid var(--border);
    display: flex; overflow-x: auto; padding: 0 16px;
    scrollbar-width: none;
  }
  .tab-bar::-webkit-scrollbar { display: none; }
  .tab-pill {
    padding: 11px 14px; border: none; background: none; cursor: pointer;
    font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--slate-light); white-space: nowrap;
    border-bottom: 3px solid transparent; font-family: 'DM Sans', sans-serif;
    transition: all 0.15s; display: flex; flex-direction: column; align-items: center; gap: 1px;
  }
  .tab-pill:hover { color: var(--slate); }
  .tab-pill.active { color: var(--navy); border-bottom-color: var(--green); }
  .tab-pill .tp-sub { font-size: 0.62rem; font-weight: 500; color: var(--green); font-variant-numeric: tabular-nums; font-style: normal; min-height: 10px; }

  /* ===== PANELS ===== */
  .panels-area { flex: 1; padding: 20px; }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ===== EXPENSE TABLE ===== */
  .exp-card {
    background: var(--white); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm);
  }
  .exp-table { width: 100%; border-collapse: collapse; }
  .exp-table thead { background: #f1f5f9; border-bottom: 2px solid var(--border); }
  .exp-table th {
    padding: 9px 12px; font-size: 0.7rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.07em; color: var(--slate);
    text-align: left;
  }
  .exp-table th.r { text-align: right; }
  .exp-table th.c { text-align: center; }
  .exp-table td { padding: 7px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  .exp-row:last-child td { border-bottom: none; }
  .exp-row:hover td { background: #fbfcfd; }
  .exp-row.is-done td { opacity: 0.45; }
  .exp-row.is-done td:first-child { opacity: 1; }

  .chk { display: flex; justify-content: center; }
  .chk input[type=checkbox] { width: 15px; height: 15px; cursor: pointer; accent-color: var(--green); }

  .inp-label { width: 100%; padding: 6px 9px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.85rem; font-family: 'DM Sans', sans-serif; color: var(--navy); outline: none; transition: border-color 0.15s; }
  .inp-label:focus { border-color: var(--green); }

  .sel-method { width: 100%; padding: 6px 9px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.8rem; font-family: 'DM Sans', sans-serif; color: var(--navy); background: white; outline: none; cursor: pointer; }
  .sel-method:focus { border-color: var(--green); }

  .inp-num {
    width: 100%; padding: 6px 9px; border: 1px solid var(--border); border-radius: 5px;
    font-size: 0.85rem; font-family: 'DM Mono', monospace; color: var(--navy);
    text-align: right; outline: none; transition: border-color 0.15s;
    background: white;
  }
  .inp-num:focus { border-color: var(--green); }
  .inp-num:disabled { background: var(--bg); color: var(--slate-light); cursor: not-allowed; }
  .inp-num.ai-hit { border-color: #93c5fd; background: #f0f7ff; }

  .cell-total { text-align: right; font-weight: 700; font-size: 0.88rem; font-family: 'DM Mono', monospace; white-space: nowrap; color: var(--slate-light); }
  .cell-total.has-val { color: var(--green); }

  .del-btn { background: none; border: none; cursor: pointer; color: var(--slate-light); padding: 3px 5px; border-radius: 4px; font-size: 0.9rem; transition: all 0.15s; }
  .del-btn:hover { color: var(--red); background: var(--red-bg); }

  .card-foot { padding: 11px 14px; display: flex; align-items: center; justify-content: space-between; background: #fafbfc; border-top: 1px solid var(--border); }
  .add-btn { padding: 7px 14px; background: white; border: 1.5px solid var(--border); border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; color: var(--slate); font-family: 'DM Sans', sans-serif; transition: all 0.15s; }
  .add-btn:hover { border-color: var(--green); color: var(--green); background: var(--green-bg); }
  .subtotal-lbl { font-size: 0.82rem; color: var(--slate); }
  .subtotal-lbl strong { color: var(--navy); font-family: 'DM Mono', monospace; font-variant-numeric: tabular-nums; }

  /* Spinner */
  .spin { width: 13px; height: 13px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 0.7s linear infinite; flex-shrink: 0; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Print */
  @media print {
    #gateWrap, .s-actions, .tab-bar, .add-btn, .del-btn, .app-nav, #aiStatusBar { display: none !important; }
    #appWrap { display: flex !important; }
    .tab-panel { display: block !important; margin-bottom: 24px; break-inside: avoid; }
    .tab-panel::before { content: attr(data-label); font-size: 0.9rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 10px; color: #0f2340; border-bottom: 2px solid #e2e8f0; padding-bottom: 6px; }
    body { background: white; }
    .panels-area { padding: 0; }
    .exp-card { box-shadow: none; border: 1px solid #d1d5db; margin-bottom: 16px; }
  }

  @media (max-width: 680px) {
    .summary-strip { padding: 10px 12px; gap: 12px; }
    .panels-area { padding: 12px; }
    .s-block.grand .sv { font-size: 1.5rem; }
    .exp-table th:nth-child(4), .exp-table td:nth-child(4),
    .exp-table th:nth-child(6), .exp-table td:nth-child(6) { display: none; }
  }
</style>
</head>
<body>

<!-- ===== GATE ===== -->
<div id="gateWrap">
  <div class="gate-card">
    <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="Utah REIA">
    <h1>Rehab Estimator</h1>
    <p class="subtitle">Enter your phone number to unlock the calculator.<br>For Utah REIA members only.</p>
    <div class="gate-field">
      <label>Phone Number</label>
      <input id="gatePhone" type="tel" placeholder="(801) 555-1234" inputmode="tel">
    </div>
    <button class="gate-btn" id="gateBtn">Unlock Estimator â†’</button>
    <div id="gateMessage"></div>
    <p class="gate-footer-note">Need access? Contact Utah REIA.</p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="appWrap">

  <nav class="app-nav">
    <div class="nav-brand">
      <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="Utah REIA">
      <span>Rehab Estimator</span>
    </div>
  </nav>



  <!-- AI Status -->
  <div id="aiStatusBar">
    <span class="spin"></span>
    <span id="aiStatusTxt"></span>
  </div>

  <!-- Summary -->
  <div class="summary-strip">
    <div class="s-block grand">
      <span class="sl">Grand Total</span>
      <span class="sv" id="grandTotal">$0.00</span>
    </div>
    <div class="s-sep"></div>
    <div class="s-block">
      <span class="sl">Completed</span>
      <span class="sv" id="doneCount">0</span>
    </div>
    <div class="s-sep"></div>
    <input type="text" id="reportTitle" placeholder="Report title â€“ e.g. 123 Main St, Salt Lake City">
    <div class="s-actions">
      <button class="btn-primary" id="aiBtn" onclick="doAIFill()">
        <span>âœ¦</span> AI Auto-Fill Prices
      </button>
      <button class="btn-secondary" onclick="exportExcel()">ðŸ“Š Export Excel</button>
      <button class="btn-secondary" onclick="window.print()">ðŸ–¨ Print</button>
      <button class="btn-secondary btn-danger" onclick="doReset()">âœ• Reset</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-bar" id="tabBar"></div>

  <!-- Panels -->
  <div class="panels-area" id="panelsArea"></div>

  <footer style="text-align:center;padding:14px;font-size:0.72rem;color:var(--slate-light);border-top:1px solid var(--border);background:white;">
    Â© 2025 Utah REIA Repair Estimator Â· All rights reserved
  </footer>
</div>

<script>
// ============================================================
// CATEGORIES & DEFAULT ITEMS
// ============================================================
const CATS = [
  { id:'roof', label:'Roof', items:[
    {label:'Roof Maintenance',method:'total'},{label:'Roof Replacement',method:'total'},
    {label:'Gutters',method:'total'},{label:'Soffit/Fascia',method:'total'}
  ]},
  { id:'ext-carp', label:'Ext Carpentry', items:[
    {label:'Siding Repair/Replace',method:'labor-material'},{label:'Exterior Doors',method:'total'},
    {label:'Windows',method:'total'},{label:'Decks/Porches',method:'total'}
  ]},
  { id:'concrete', label:'Concrete', items:[
    {label:'Driveway',method:'per-sqft'},{label:'Sidewalk/Walkway',method:'per-sqft'},
    {label:'Patio Slab',method:'per-sqft'},{label:'Foundation Repair',method:'total'}
  ]},
  { id:'garage', label:'Garage', items:[
    {label:'Garage Door',method:'total'},{label:'Garage Door Opener',method:'total'},
    {label:'Garage Floor Epoxy',method:'per-sqft'}
  ]},
  { id:'landscaping', label:'Landscaping', items:[
    {label:'Lawn/Sod',method:'per-sqft'},{label:'Tree Trimming/Removal',method:'total'},
    {label:'Sprinkler System',method:'total'},{label:'Cleanup/Haul Away',method:'total'}
  ]},
  { id:'painting', label:'Painting', items:[
    {label:'Interior Paint â€“ Full House',method:'per-sqft'},{label:'Exterior Paint',method:'per-sqft'},
    {label:'Trim & Doors',method:'total'},{label:'Cabinets Painted',method:'total'}
  ]},
  { id:'septic', label:'Septic', items:[
    {label:'Septic Inspection',method:'total'},{label:'Septic Pump/Clean',method:'total'},
    {label:'Septic Repair',method:'total'},{label:'New Septic System',method:'total'}
  ]},
  { id:'foundation', label:'Foundation', items:[
    {label:'Crack Injection',method:'total'},{label:'Waterproofing',method:'total'},
    {label:'Pier/Beam Repair',method:'total'}
  ]},
  { id:'fences', label:'Fences', items:[
    {label:'Wood Fence',method:'total'},{label:'Vinyl Fence',method:'total'},
    {label:'Chain Link Fence',method:'total'},{label:'Gate',method:'total'}
  ]},
  { id:'kitchen', label:'Kitchen', items:[
    {label:'Cabinets',method:'total'},{label:'Countertops',method:'per-sqft'},
    {label:'Appliances',method:'total'},{label:'Sink & Faucet',method:'total'},
    {label:'Backsplash',method:'per-sqft'}
  ]},
  { id:'bathrooms', label:'Bathrooms', items:[
    {label:'Full Bathroom Remodel',method:'total'},{label:'Vanity & Fixtures',method:'total'},
    {label:'Shower/Tub',method:'total'},{label:'Tile Work',method:'per-sqft'},
    {label:'Toilet',method:'total'}
  ]},
  { id:'flooring', label:'Flooring', items:[
    {label:'Hardwood',method:'per-sqft'},{label:'LVP/LVT',method:'per-sqft'},
    {label:'Carpet',method:'per-sqft'},{label:'Tile',method:'per-sqft'}
  ]},
  { id:'hvac', label:'HVAC', items:[
    {label:'Furnace Replacement',method:'total'},{label:'A/C Unit',method:'total'},
    {label:'Ductwork',method:'total'},{label:'Water Heater',method:'total'}
  ]},
  { id:'plumbing', label:'Plumbing', items:[
    {label:'Re-pipe (Partial)',method:'total'},{label:'Re-pipe (Full)',method:'total'},
    {label:'Drain Line Repair',method:'total'},{label:'Fixtures',method:'total'}
  ]},
  { id:'electrical', label:'Electrical', items:[
    {label:'Panel Upgrade',method:'total'},{label:'Rewire (Partial)',method:'total'},
    {label:'Outlets/Switches',method:'total'},{label:'Light Fixtures',method:'total'}
  ]},
  { id:'demo', label:'Demo', items:[
    {label:'Interior Demo',method:'total'},{label:'Dumpster Rental',method:'total'},
    {label:'Haul Away',method:'total'}
  ]},
  { id:'misc', label:'Misc', items:[
    {label:'General Conditions',method:'total'},{label:'Permits',method:'total'},
    {label:'Contingency',method:'total'}
  ]}
];

const STORE = 'utah_reia_v5';
let state = {};
let activeTab = CATS[0].id;

// ============================================================
// GATE
// ============================================================
(function() {
  const GATE_KEY = 'utah_reia_access';
  if (localStorage.getItem(GATE_KEY) === '1') { show(); return; }
  document.getElementById('gateBtn').onclick = async () => {
    const phone = document.getElementById('gatePhone').value.replace(/\D/g,'');
    const msg = document.getElementById('gateMessage');
    const inp = document.getElementById('gatePhone');
    msg.innerText = ''; inp.style.borderColor = '';
    if (phone.length < 10) { msg.innerText = 'Please enter a valid 10-digit phone number.'; inp.style.borderColor = 'var(--red)'; return; }
    msg.innerText = 'Verifyingâ€¦';
    try {
      const r = await fetch('https://rehab-estimator-delta.vercel.app/api/verify-phone', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({phone})
      });
      const d = await r.json();
      if (d.valid) { localStorage.setItem(GATE_KEY,'1'); show(); }
      else { msg.innerText = 'Phone number not found. Access denied.'; inp.style.borderColor = 'var(--red)'; }
    } catch(e) { localStorage.setItem(GATE_KEY,'1'); show(); }
  };
  document.getElementById('gatePhone').onkeydown = e => { if (e.key==='Enter') document.getElementById('gateBtn').click(); };
  function show() {
    document.getElementById('gateWrap').style.display = 'none';
    document.getElementById('appWrap').style.display = 'flex';
    document.getElementById('appWrap').style.flexDirection = 'column';
    initApp();
  }
})();

// ============================================================
// INIT
// ============================================================
function initApp() {
  loadState();
  buildTabs();
  buildPanels();
  renderAll();
  recalcAll();
  loadTitle();
}

// ============================================================
// API KEY
// ============================================================


// ============================================================
// STATE
// ============================================================
function loadState() {
  try { state = JSON.parse(localStorage.getItem(STORE)) || {}; } catch(e) { state = {}; }
  CATS.forEach(cat => {
    if (!state[cat.id]) {
      state[cat.id] = { rows: cat.items.map(it => ({ label:it.label, method:it.method, qty:'', labor:'', material:'', done:false, aiHit:false })) };
    }
  });
}
function persist() { localStorage.setItem(STORE, JSON.stringify(state)); }

// ============================================================
// TABS
// ============================================================
function buildTabs() {
  const bar = document.getElementById('tabBar');
  bar.innerHTML = '';
  CATS.forEach(cat => {
    const b = document.createElement('button');
    b.className = 'tab-pill' + (cat.id===activeTab?' active':'');
    b.id = 'tp-' + cat.id;
    b.innerHTML = `${cat.label}<span class="tp-sub" id="tpsub-${cat.id}"></span>`;
    b.onclick = () => switchTab(cat.id);
    bar.appendChild(b);
  });
}
function switchTab(id) {
  document.querySelectorAll('.tab-pill').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tp-'+id).classList.add('active');
  document.getElementById('panel-'+id).classList.add('active');
  activeTab = id;
}

// ============================================================
// PANELS
// ============================================================
function buildPanels() {
  const area = document.getElementById('panelsArea');
  area.innerHTML = '';
  CATS.forEach(cat => {
    const d = document.createElement('div');
    d.className = 'tab-panel' + (cat.id===activeTab?' active':'');
    d.id = 'panel-' + cat.id;
    d.setAttribute('data-label', cat.label);
    d.innerHTML = `
      <div class="exp-card">
        <table class="exp-table">
          <thead>
            <tr>
              <th class="c" style="width:40px;">Done</th>
              <th>Label</th>
              <th style="width:155px;">Calculation Method</th>
              <th class="r" style="width:95px;">Qty / SqFt</th>
              <th class="r" style="width:110px;">Labor ($)</th>
              <th class="r" style="width:110px;">Material ($)</th>
              <th class="r" style="width:105px;">Total</th>
              <th style="width:34px;"></th>
            </tr>
          </thead>
          <tbody id="tbody-${cat.id}"></tbody>
        </table>
        <div class="card-foot">
          <button class="add-btn" onclick="addRow('${cat.id}')">+ Add expense</button>
          <span class="subtotal-lbl">Subtotal: <strong id="sub-${cat.id}">$0.00</strong></span>
        </div>
      </div>`;
    area.appendChild(d);
  });
}

// ============================================================
// RENDER
// ============================================================
function renderAll() { CATS.forEach(c => renderRows(c.id)); }

function renderRows(cid) {
  const tbody = document.getElementById('tbody-' + cid);
  tbody.innerHTML = '';
  state[cid].rows.forEach((row, i) => tbody.appendChild(mkRow(cid, i, row)));
}

function mkRow(cid, i, row) {
  const isTot = row.method === 'total';
  const isPSF = row.method === 'per-sqft';
  const isLM  = row.method === 'labor-material';
  const disableQty = isTot;
  const disableMat = isTot;
  const laborPH = isTot ? 'Total $' : '0.00';

  const tr = document.createElement('tr');
  tr.className = 'exp-row' + (row.done ? ' is-done' : '');
  tr.id = `r-${cid}-${i}`;
  tr.innerHTML = `
    <td class="chk"><input type="checkbox" ${row.done?'checked':''} onchange="onDone('${cid}',${i},this.checked)"></td>
    <td><input class="inp-label" type="text" value="${esc(row.label)}" placeholder="Descriptionâ€¦" oninput="onF('${cid}',${i},'label',this.value)"></td>
    <td>
      <select class="sel-method" onchange="onMethod('${cid}',${i},this.value)">
        <option value="total" ${isTot?'selected':''}>Total Only</option>
        <option value="labor-material" ${isLM?'selected':''}>Labor + Material</option>
        <option value="per-sqft" ${isPSF?'selected':''}>Per SqFt</option>
      </select>
    </td>
    <td><input class="inp-num" type="number" min="0" value="${row.qty}" placeholder="${isPSF?'SqFt':'Qty'}" ${disableQty?'disabled':''} oninput="onF('${cid}',${i},'qty',this.value)"></td>
    <td><input class="inp-num${row.aiHit?' ai-hit':''}" type="number" min="0" value="${row.labor}" placeholder="${laborPH}" oninput="onF('${cid}',${i},'labor',this.value)"></td>
    <td><input class="inp-num${row.aiHit?' ai-hit':''}" type="number" min="0" value="${row.material}" placeholder="0.00" ${disableMat?'disabled':''} oninput="onF('${cid}',${i},'material',this.value)"></td>
    <td class="cell-total" id="ct-${cid}-${i}">$0.00</td>
    <td><button class="del-btn" title="Remove" onclick="delRow('${cid}',${i})">âœ•</button></td>
  `;
  return tr;
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }

// ============================================================
// EVENTS
// ============================================================
function onDone(cid, i, v) {
  state[cid].rows[i].done = v;
  const tr = document.getElementById(`r-${cid}-${i}`);
  if (tr) v ? tr.classList.add('is-done') : tr.classList.remove('is-done');
  recalcAll(); persist();
}
function onF(cid, i, field, val) {
  state[cid].rows[i][field] = val;
  updateRowTotal(cid, i);
  updateCatTotal(cid);
  updateGrand();
  persist();
}
function onMethod(cid, i, val) {
  state[cid].rows[i].method = val;
  renderRows(cid);
  recalcAll(); persist();
}
function addRow(cid) {
  state[cid].rows.push({label:'',method:'total',qty:'',labor:'',material:'',done:false,aiHit:false});
  renderRows(cid);
  recalcAll(); persist();
  const tbody = document.getElementById('tbody-'+cid);
  const last = tbody.lastElementChild;
  if (last) { const inp = last.querySelector('.inp-label'); if(inp) inp.focus(); }
}
function delRow(cid, i) {
  state[cid].rows.splice(i,1);
  renderRows(cid);
  recalcAll(); persist();
}

// ============================================================
// CALC
// ============================================================
function rowTotal(row) {
  const q = parseFloat(row.qty)||0;
  const l = parseFloat(row.labor)||0;
  const m = parseFloat(row.material)||0;
  if (row.method==='total') return l;
  if (row.method==='labor-material') return (q||1)*(l+m);
  if (row.method==='per-sqft') return q*(l+m);
  return 0;
}
function updateRowTotal(cid, i) {
  const t = rowTotal(state[cid].rows[i]);
  const cell = document.getElementById(`ct-${cid}-${i}`);
  if (cell) { cell.innerText = fmt(t); t>0 ? cell.classList.add('has-val') : cell.classList.remove('has-val'); }
}
function updateCatTotal(cid) {
  let sum = 0;
  state[cid].rows.forEach((_,i) => { updateRowTotal(cid,i); sum += rowTotal(state[cid].rows[i]); });
  const s = document.getElementById('sub-'+cid); if(s) s.innerText = fmt(sum);
  const t = document.getElementById('tpsub-'+cid); if(t) t.innerText = sum>0 ? fmt(sum,0) : '';
}
function updateGrand() {
  let grand=0, done=0;
  CATS.forEach(c => { state[c.id].rows.forEach(r => { grand+=rowTotal(r); if(r.done) done++; }); });
  document.getElementById('grandTotal').innerText = fmt(grand);
  document.getElementById('doneCount').innerText = done;
}
function recalcAll() { CATS.forEach(c => updateCatTotal(c.id)); updateGrand(); }
function fmt(n, d=2) { return '$'+(n||0).toLocaleString('en-US',{minimumFractionDigits:d,maximumFractionDigits:d}); }

// ============================================================
// RESET / TITLE
// ============================================================
function doReset() {
  if (!confirm('Reset all data to defaults?')) return;
  localStorage.removeItem(STORE); state = {}; loadState(); renderAll(); recalcAll();
}
function loadTitle() {
  document.getElementById('reportTitle').value = localStorage.getItem('reia_title')||'';
  document.getElementById('reportTitle').oninput = function() { localStorage.setItem('reia_title', this.value); };
}

// ============================================================
// AI AUTO-FILL
// ============================================================
// Proxy URL â€” your Vercel backend keeps the OpenAI key server-side, never exposed in the browser
const PROXY_URL = 'https://rehab-estimator-delta.vercel.app/api/ai-pricing';

async function doAIFill() {
  const btn = document.getElementById('aiBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin" style="border-color:#fff;border-top-color:transparent"></span> Fetchingâ€¦';
  aiStatus('loading', 'Asking AI for current Utah market pricingâ€¦ this may take a few seconds.');

  const items = [];
  CATS.forEach(cat => {
    state[cat.id].rows.forEach(row => {
      if (row.label) items.push({ cat: cat.label, label: row.label, method: row.method });
    });
  });

  try {
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Server error'); }
    const data = await res.json();
    if (!data.prices) throw new Error('No prices returned');

    let count = 0;
    CATS.forEach(cat => {
      state[cat.id].rows.forEach((row, i) => {
        const key = `${cat.label}|${row.label}`;
        const p = data.prices[key];
        if (p) {
          if (typeof p.labor === 'number') state[cat.id].rows[i].labor = p.labor.toFixed(2);
          if (typeof p.material === 'number' && row.method !== 'total') state[cat.id].rows[i].material = p.material.toFixed(2);
          state[cat.id].rows[i].aiHit = true;
          count++;
        }
      });
    });

    renderAll(); recalcAll(); persist();
    aiStatus('success', `âœ“ AI filled ${count} line items with current Utah market prices (2024-2025). Blue-highlighted fields were AI-estimated â€” review and adjust as needed.`);
  } catch(e) {
    aiStatus('error', 'âš  Error: ' + e.message);
  }

  btn.disabled = false;
  btn.innerHTML = '<span>âœ¦</span> AI Auto-Fill Prices';
}

// ============================================================
// EXCEL EXPORT
// ============================================================
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const title = document.getElementById('reportTitle').value || 'Rehab Estimate';

  // --- SUMMARY SHEET ---
  const summaryRows = [
    ['Utah REIA â€“ Rehab Estimator'],
    ['Report:', title],
    ['Date:', new Date().toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' })],
    [],
    ['CATEGORY', 'SUBTOTAL']
  ];
  let grandTotal = 0;
  CATS.forEach(cat => {
    let sub = 0;
    state[cat.id].rows.forEach(row => sub += rowTotal(row));
    if (sub > 0) {
      summaryRows.push([cat.label, sub]);
      grandTotal += sub;
    }
  });
  summaryRows.push([]);
  summaryRows.push(['GRAND TOTAL', grandTotal]);

  const wsSummary = XLSX.utils.aoa_to_sheet(summaryRows);
  // Column widths
  wsSummary['!cols'] = [{ wch: 28 }, { wch: 16 }];
  // Style grand total row bold (basic)
  const lastRow = summaryRows.length;
  wsSummary['!merges'] = [];
  XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

  // --- ONE SHEET PER CATEGORY (with data) ---
  CATS.forEach(cat => {
    const rows = state[cat.id].rows;
    const hasData = rows.some(r => r.label || parseFloat(r.labor) || parseFloat(r.material));
    if (!hasData) return;

    const sheetRows = [
      [cat.label.toUpperCase()],
      [],
      ['Done', 'Description', 'Calc Method', 'Qty / SqFt', 'Labor ($)', 'Material ($)', 'Total ($)']
    ];

    let catTotal = 0;
    rows.forEach(row => {
      if (!row.label && !row.labor && !row.material) return;
      const tot = rowTotal(row);
      catTotal += tot;
      sheetRows.push([
        row.done ? 'Yes' : 'No',
        row.label || '',
        row.method === 'total' ? 'Total Only' : row.method === 'labor-material' ? 'Labor + Material' : 'Per SqFt',
        parseFloat(row.qty) || '',
        parseFloat(row.labor) || '',
        row.method !== 'total' ? (parseFloat(row.material) || '') : '',
        tot || ''
      ]);
    });

    sheetRows.push([]);
    sheetRows.push(['', '', '', '', '', 'SUBTOTAL:', catTotal]);

    const ws = XLSX.utils.aoa_to_sheet(sheetRows);
    ws['!cols'] = [
      { wch: 6 }, { wch: 28 }, { wch: 18 }, { wch: 12 },
      { wch: 12 }, { wch: 14 }, { wch: 14 }
    ];
    // Shorten sheet name to 31 chars (Excel limit)
    const sheetName = cat.label.substring(0, 31);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  });

  // Download
  const safeTitle = title.replace(/[^a-z0-9]/gi, '_').substring(0, 40) || 'Rehab_Estimate';
  XLSX.writeFile(wb, `${safeTitle}.xlsx`);
}

function aiStatus(type, msg) {
  const bar = document.getElementById('aiStatusBar');
  bar.className = type; bar.style.display = 'flex';
  document.getElementById('aiStatusTxt').innerText = msg;
  if (type !== 'loading') setTimeout(() => { bar.className=''; bar.style.display='none'; }, 9000);
}
</script>
</body>
</html>
