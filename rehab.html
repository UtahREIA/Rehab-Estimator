<style>
  :root {
    --blue: #1e3a8a; /* Utah REIA Blue */
    --muted: #64748b;
    --bg-color: #f1f5f9;
  }

  /* --- 1. GATE STYLES (Login Screen) --- */
  #gateWrap {
    max-width: 400px;
    margin: 40px auto;
    padding: 30px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    font-family: 'Segoe UI', sans-serif;
    text-align: center;
    border: 1px solid #e2e8f0;
  }

  #gateWrap .top img {
    max-width: 180px;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  #gateWrap h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
  #gateWrap .subtitle { font-size: 0.95rem; color: var(--muted); line-height: 1.4; }
  
  #gateWrap .card { margin-top: 20px; text-align: left; }
  #gateWrap label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #334155; }
  
  #gateWrap input { width: 100%; box-sizing: border-box; border: 1px solid #cbd5e1; border-radius: 6px; transition: 0.2s; }
  #gateWrap input:focus { outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
  
  #gateWrap .btn { background: var(--blue); color: white; border: none; font-weight: 600; font-size: 1rem; padding: 12px; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
  #gateWrap .btn:hover { background: #172554; }

  /* --- 2. CALCULATOR STYLES (Hidden by default) --- */
  #rehab-widget {
    display: none; /* HIDDEN INITIALLY */
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    background: #ffffff;
    border: 1px solid #cbd5e1;
    max-width: 100%;
    margin: 20px auto;
    color: #334155;
    box-sizing: border-box;
  }
  
  #rehab-widget * { box-sizing: border-box; }

  /* Header */
  .rw-header {
    background: #f0fdf4; 
    border-bottom: 2px solid #86efac;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* LOGO STYLING IN CALCULATOR */
  .rw-logo-area img {
    max-width: 160px; /* Adjust size here */
    height: auto;
    display: block;
    margin-bottom: 8px;
  }

  .rw-logo-area h2 { margin: 0; color: #166534; font-size: 1.4rem; text-transform: uppercase; }
  .rw-logo-area p { margin: 5px 0 0; font-size: 0.85rem; color: #15803d; }

  .rw-big-total {
    text-align: right;
    background: #fff;
    padding: 15px 25px;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  .rw-big-total .label { display: block; font-size: 0.75rem; font-weight: 700; color: #65a30d; text-transform: uppercase; }
  .rw-big-total .value { font-size: 2.2rem; font-weight: 800; color: #14532d; line-height: 1.1; margin-top: 5px; }

  /* Dashboard */
  .rw-dashboard {
    display: flex;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .rw-scope-breakdown { flex: 2; padding: 15px; border-right: 1px solid #cbd5e1; }
  .rw-section-title {
    font-size: 0.85rem; font-weight: 700; text-transform: uppercase;
    color: #475569; margin-bottom: 10px; text-align: center;
    background: #e2e8f0; padding: 5px; border-radius: 4px;
  }

  .rw-scope-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 8px 20px;
  }

  .rw-scope-item {
    display: flex; justify-content: space-between; font-size: 0.8rem;
    border-bottom: 1px solid #f1f5f9; padding-bottom: 2px;
  }
  .rw-scope-name { color: #64748b; font-weight: 500; }
  .rw-scope-val { font-weight: 700; color: #334155; }

  .rw-rooms-breakdown { flex: 1; padding: 15px; background: #fff; min-width: 250px; }
  .rw-room-row { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
  .rw-room-row span { font-size: 0.8rem; font-weight: 600; color: #475569; }
  .rw-room-input { width: 100px; padding: 4px; font-size: 0.8rem; text-align: right; border: 1px solid #cbd5e1; border-radius: 4px; }

  /* Table */
  .rw-table-container { overflow-x: auto; width: 100%; }
  table.rw-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  table.rw-table th {
    background: #f1f5f9; text-align: left; padding: 10px;
    font-size: 0.75rem; text-transform: uppercase; color: #475569;
    border-bottom: 2px solid #cbd5e1; border-top: 1px solid #e2e8f0;
  }
  table.rw-table td { padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
  
  .rw-inp { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }
  .rw-inp:focus { outline: none; border-color: #16a34a; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2); }
  .rw-inp-qty { width: 60px; text-align: center; }
  .rw-inp-money { text-align: right; }
  .rw-row-total { font-weight: 700; text-align: right; color: #1e293b; }

  /* Footer & Actions */
  .rw-footer { background: #1e293b; color: #94a3b8; text-align: center; padding: 10px; font-size: 0.75rem; }
  .rw-actions { padding: 15px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0; }
  .rw-btn { padding: 8px 16px; border: none; border-radius: 4px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
  .btn-print { background: #0f172a; color: #fff; }
  .btn-clear { background: #fee2e2; color: #991b1b; }

  /* Responsive & Print */
  @media (max-width: 768px) {
    .rw-dashboard { flex-direction: column; }
    .rw-scope-breakdown { border-right: none; border-bottom: 1px solid #cbd5e1; }
    .rw-header { flex-direction: column; text-align: center; }
    .rw-logo-area img { margin: 0 auto 10px auto; }
    .rw-big-total { width: 100%; text-align: center; }
  }

  @media print {
    #gateWrap { display: none !important; } /* Hide login on print */
    #rehab-widget { display: block !important; border: none; width: 100%; }
    .rw-actions { display: none; }
    .rw-dashboard { display: flex !important; flex-direction: row !important; }
    .rw-scope-grid { grid-template-columns: repeat(2, 1fr); font-size: 0.7rem; }
    .rw-inp, input { border: none; background: transparent; padding: 0; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
  }
</style>

<div class="wrap" id="gateWrap">
  <div class="top"><img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo"></div>
  <h1 style="text-align:center;color:var(--blue);margin-top:12px;">Rehab Estimator Access</h1>
  <div class="subtitle" style="margin-bottom:16px;">Enter your phone number to unlock the calculator.</div>
  <div class="card">
    <div class="field">
      <label>Phone Number</label>
      <input id="gatePhone" type="tel" placeholder="(801) 555-1234" inputmode="tel" style="font-size:16px;padding:12px">
    </div>
    <div class="field">
      <button type="button" class="btn" id="gateSubmitBtn" style="width:100%;margin-top:8px;">Unlock Estimator</button>
    </div>
    <div id="gateMessage" class="muted-small" style="margin-top:8px;min-height:18px;color:#b00020;text-align:center;font-size:0.85rem;"></div>
  </div>
  <div style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">For UTAH REIA members only. Need access? Contact us.</div>
</div>

<div id="rehab-widget">
  <div class="rw-header">
    <div class="rw-logo-area">
      <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo">
      <h2>Repair Estimator</h2>
      <p>Project Cost Calculator</p>
    </div>
    <div class="rw-big-total">
      <span class="label">Total Estimate</span>
      <div class="value" id="disp-grand-total">$0.00</div>
    </div>
  </div>

  <div class="rw-dashboard">
    <div class="rw-scope-breakdown">
      <div class="rw-section-title">Estimate Breakdown by Scope of Work</div>
      <div class="rw-scope-grid" id="scope-breakdown-grid"></div>
    </div>
    <div class="rw-rooms-breakdown">
      <div class="rw-section-title">Rooms (Manual)</div>
      <div id="rooms-container">
        <div class="rw-room-row"><span>Kitchen</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Bathrooms</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Bedrooms</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Living Areas</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row" style="border-top:1px solid #eee; padding-top:5px; margin-top:5px;">
          <span>TOTAL:</span><strong id="rooms-total-disp">$0.00</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="rw-table-container">
    <table class="rw-table">
      <thead>
        <tr>
          <th style="width: 30%;">Description of Work</th>
          <th style="width: 10%; text-align:center;">Qty</th>
          <th style="text-align:right;">Labor <small>($/unit)</small></th>
          <th style="text-align:right;">Material <small>($/unit)</small></th>
          <th style="text-align:right;">Sub <small>($/unit)</small></th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody id="rw-main-tbody"></tbody>
    </table>
  </div>

  <div class="rw-actions">
    <button class="rw-btn btn-clear" onclick="app.reset()">Reset</button>
    <button class="rw-btn btn-print" onclick="window.print()">Print Estimate</button>
  </div>
  <div class="rw-footer">&copy; 2024 Repair Estimator Tool. All rights reserved.</div>
</div>

<script>
// --- GATE CONTROLLER ---
(function() {
  const GATE_KEY = 'utah_reia_access_token';
  const gateWrap = document.getElementById('gateWrap');
  const widget = document.getElementById('rehab-widget');
  const btn = document.getElementById('gateSubmitBtn');
  const phoneInput = document.getElementById('gatePhone');
  const msg = document.getElementById('gateMessage');

  // Check if unlocked
  if(localStorage.getItem(GATE_KEY) === 'unlocked') {
    unlock();
  }

  // Button Logic
  btn.addEventListener('click', async function() {
    const phone = phoneInput.value.replace(/\D/g,''); // strip non-digits
    msg.innerText = "";
    phoneInput.style.borderColor = "#cbd5e1";
    if(phone.length < 10) {
      msg.innerText = "Please enter a valid 10-digit phone number.";
      phoneInput.style.borderColor = "#b00020";
      return;
    }

    msg.innerText = "Verifying...";
    try {
      const response = await fetch('https://rehab-estimator-delta.vercel.app/api/verify-phone', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone })
      });
      const data = await response.json();
      if (data.valid) {
        localStorage.setItem(GATE_KEY, 'unlocked');
        msg.innerText = "";
        unlock();
      } else {
        msg.innerText = "Phone number not found. Access denied.";
        phoneInput.style.borderColor = "#b00020";
      }
    } catch (e) {
      msg.innerText = "Verification failed. Please try again later.";
      phoneInput.style.borderColor = "#b00020";
    }
  });

  function unlock() {
    gateWrap.style.display = 'none';
    widget.style.display = 'block';
  }
})();

// --- CALCULATOR APP ---
const app = (function() {
  const STORAGE_KEY = 'ghl_est_data_v2';
  const categories = [
    "General Conditions", "Demolition", "Concrete & Flatwork", "Masonry", "Siding",
    "Roofing", "Ext. Doors & Windows", "Garage Doors", "Landscaping", "Framing & Drywall",
    "Cabinets & Countertops", "Doors & Trim", "Carpet & Resilient", "Hardwood Flooring",
    "Tiling", "Painting", "Appliances", "Plumbing", "HVAC", "Electrical", "Miscellaneous"
  ];

  const tbody = document.getElementById('rw-main-tbody');
  const scopeGrid = document.getElementById('scope-breakdown-grid');
  const grandTotalDisp = document.getElementById('disp-grand-total');
  const roomsInputs = document.querySelectorAll('.rw-room-input');
  const roomsTotalDisp = document.getElementById('rooms-total-disp');

  function init() {
    buildTable();
    buildScopeGrid();
    loadData();
    attachListeners();
  }

  function buildTable() {
    tbody.innerHTML = '';
    categories.forEach((cat, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:600;">${cat}</td>
        <td style="text-align:center;"><input type="number" class="rw-inp rw-inp-qty" data-idx="${idx}" placeholder="0"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-l" data-idx="${idx}" placeholder="0.00"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-m" data-idx="${idx}" placeholder="0.00"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-s" data-idx="${idx}" placeholder="0.00"></td>
        <td class="rw-row-total" id="row-total-${idx}">$0.00</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildScopeGrid() {
    scopeGrid.innerHTML = '';
    categories.forEach((cat, idx) => {
      const div = document.createElement('div');
      div.className = 'rw-scope-item';
      div.innerHTML = `<span class="rw-scope-name">${cat}</span><span class="rw-scope-val" id="scope-val-${idx}">$0</span>`;
      scopeGrid.appendChild(div);
    });
  }

  function calculate() {
    let grandTotal = 0;
    categories.forEach((_, idx) => {
      const qty = getVal(`input.rw-inp-qty[data-idx="${idx}"]`);
      const l = getVal(`input.inp-l[data-idx="${idx}"]`);
      const m = getVal(`input.inp-m[data-idx="${idx}"]`);
      const s = getVal(`input.inp-s[data-idx="${idx}"]`);
      const rowSum = qty * (l + m + s);
      grandTotal += rowSum;
      document.getElementById(`row-total-${idx}`).innerText = fmt(rowSum);
      const scopeItem = document.getElementById(`scope-val-${idx}`);
      if(scopeItem) {
        scopeItem.innerText = fmt(rowSum, 0);
        scopeItem.style.color = rowSum > 0 ? '#0f172a' : '#cbd5e1';
      }
    });
    grandTotalDisp.innerText = fmt(grandTotal);
    let roomSum = 0;
    roomsInputs.forEach(inp => roomSum += parseFloat(inp.value) || 0);
    roomsTotalDisp.innerText = fmt(roomSum);
    saveData();
  }

  function getVal(selector) { const el = document.querySelector(selector); return el ? (parseFloat(el.value) || 0) : 0; }
  function fmt(num, decimals = 2) { return '$' + num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
  function attachListeners() { tbody.addEventListener('input', calculate); roomsInputs.forEach(i => i.addEventListener('input', calculate)); }
  function saveData() {
    const data = { rows: [], rooms: [] };
    categories.forEach((_, idx) => {
      data.rows.push({
        q: document.querySelector(`input.rw-inp-qty[data-idx="${idx}"]`).value,
        l: document.querySelector(`input.inp-l[data-idx="${idx}"]`).value,
        m: document.querySelector(`input.inp-m[data-idx="${idx}"]`).value,
        s: document.querySelector(`input.inp-s[data-idx="${idx}"]`).value
      });
    });
    roomsInputs.forEach(inp => data.rooms.push(inp.value));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      if (data.rows) {
        data.rows.forEach((row, idx) => {
          document.querySelector(`input.rw-inp-qty[data-idx="${idx}"]`).value = row.q;
          document.querySelector(`input.inp-l[data-idx="${idx}"]`).value = row.l;
          document.querySelector(`input.inp-m[data-idx="${idx}"]`).value = row.m;
          document.querySelector(`input.inp-s[data-idx="${idx}"]`).value = row.s;
        });
      }
      if (data.rooms) { data.rooms.forEach((val, idx) => { if (roomsInputs[idx]) roomsInputs[idx].value = val; }); }
      calculate();
    } catch (e) {}
  }
  function reset() {
    if(confirm('Clear all data?')) { localStorage.removeItem(STORAGE_KEY); document.querySelectorAll('#rehab-widget input').forEach(i => i.value = ''); calculate(); }
  }
  document.addEventListener('DOMContentLoaded', init);
  return { reset };
})();
</script>