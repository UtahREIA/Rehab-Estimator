<style>
  /* --- GLOBAL VARIABLES --- */
  :root {
    --blue: #1e3a8a;
    --muted: #64748b;
    --bg-color: #f1f5f9;
    --green-light: #f0fdf4;
    --green-border: #86efac;
    --ai-bg: #eff6ff;
    --ai-border: #bfdbfe;
    --ai-text: #1e40af;
  }

  @media print {
    body * { visibility: hidden !important; }
    #rehab-widget, #rehab-widget * { visibility: visible !important; }
    #rehab-widget { position: absolute !important; left: 0; top: 0; width: 100vw !important; background: #fff !important; z-index: 9999 !important; border: none !important; }
    #gateWrap, .rw-actions, .rw-ai-toolbar { display: none !important; } /* Hide AI bar on print */
    .rw-dashboard { display: flex !important; flex-direction: row !important; }
    .rw-scope-grid { grid-template-columns: repeat(2, 1fr); font-size: 0.7rem; }
    .rw-inp { border: none !important; padding: 0 !important; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
  }

  /* --- 1. GATE STYLES --- */
  #gateWrap {
    max-width: 400px; margin: 40px auto; padding: 30px;
    background: #ffffff; border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    font-family: 'Segoe UI', sans-serif; text-align: center; border: 1px solid #e2e8f0;
  }
  #gateWrap img { max-width: 180px; height: auto; display: block; margin: 0 auto; }
  #gateWrap h1 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--blue); }
  #gateWrap .subtitle { font-size: 0.95rem; color: var(--muted); line-height: 1.4; }
  #gateWrap .card { margin-top: 20px; text-align: left; }
  #gateWrap label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #334155; }
  #gateWrap input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 16px; }
  #gateWrap .btn { width: 100%; margin-top: 8px; background: var(--blue); color: white; border: none; padding: 12px; border-radius: 6px; font-size: 1rem; font-weight: 600; cursor: pointer; }
  
  /* --- 2. CALCULATOR STYLES --- */
  #rehab-widget {
    display: none; /* Hidden until unlocked */
    font-family: 'Segoe UI', sans-serif; background: #fff;
    border: 1px solid #cbd5e1; max-width: 100%; margin: 20px auto; color: #334155;
    box-sizing: border-box;
  }
  #rehab-widget * { box-sizing: border-box; }

  /* Header */
  .rw-header {
    background: var(--green-light); border-bottom: 2px solid var(--green-border); padding: 20px;
    display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
  }
  .rw-logo-area img { max-width: 160px; display: block; margin-bottom: 8px; }
  .rw-logo-area h2 { margin: 0; color: #166534; font-size: 1.4rem; text-transform: uppercase; }
  .rw-big-total {
    text-align: right; background: #fff; padding: 15px 25px;
    border: 1px solid #bbf7d0; border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  }
  .rw-big-total .label { display: block; font-size: 0.75rem; font-weight: 700; color: #65a30d; text-transform: uppercase; }
  .rw-big-total .value { font-size: 2.2rem; font-weight: 800; color: #14532d; line-height: 1.1; margin-top: 5px; }

  /* Dashboard */
  .rw-dashboard { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
  .rw-scope-breakdown { flex: 2; padding: 15px; border-right: 1px solid #cbd5e1; }
  .rw-section-title { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; color: #475569; margin-bottom: 10px; text-align: center; background: #e2e8f0; padding: 5px; border-radius: 4px; }
  .rw-scope-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px 20px; }
  .rw-scope-item { display: flex; justify-content: space-between; font-size: 0.8rem; border-bottom: 1px solid #f1f5f9; }
  .rw-rooms-breakdown { flex: 1; padding: 15px; background: #fff; min-width: 250px; }
  .rw-room-row { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
  .rw-room-input { width: 100px; padding: 4px; text-align: right; border: 1px solid #cbd5e1; border-radius: 4px; }

  /* --- AI TOOLBAR (NEW) --- */
  .rw-ai-toolbar {
    background: var(--ai-bg); border-bottom: 1px solid var(--ai-border);
    padding: 15px 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;
  }
  .rw-ai-label { font-weight: 700; color: var(--ai-text); display: flex; align-items: center; gap: 8px; }
  .rw-ai-select { padding: 8px; border: 1px solid var(--ai-border); border-radius: 4px; color: #1e3a8a; font-weight: 600; min-width: 250px; }
  .rw-btn-ai {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white; border: none; padding: 8px 16px; border-radius: 4px;
    font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;
    box-shadow: 0 2px 4px rgba(37,99,235,0.2); transition: transform 0.1s;
  }
  .rw-btn-ai:active { transform: scale(0.98); }

  /* Table */
  .rw-table-container { overflow-x: auto; width: 100%; }
  table.rw-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  table.rw-table th { background: #f1f5f9; text-align: left; padding: 10px; border-bottom: 2px solid #cbd5e1; font-size: 0.75rem; text-transform: uppercase; color: #475569; }
  table.rw-table td { padding: 8px 10px; border-bottom: 1px solid #e2e8f0; }
  .rw-inp { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; }
  .rw-inp:focus { outline: none; border-color: #16a34a; }
  .rw-inp-qty { width: 60px; text-align: center; }
  .rw-inp-money { text-align: right; }
  .rw-row-total { font-weight: 700; text-align: right; color: #1e293b; }

  /* Footer */
  .rw-footer { background: #1e293b; color: #94a3b8; text-align: center; padding: 10px; font-size: 0.75rem; }
  .rw-actions { padding: 15px; background: #f8fafc; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e2e8f0; }
  .rw-btn { padding: 8px 16px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; }
  .btn-print { background: #0f172a; color: #fff; }
  .btn-clear { background: #fee2e2; color: #991b1b; }

  @media (max-width: 768px) {
    .rw-dashboard { flex-direction: column; }
    .rw-scope-breakdown { border-right: none; }
    .rw-header { flex-direction: column; text-align: center; }
    .rw-logo-area img { margin: 0 auto 10px auto; }
    .rw-big-total { width: 100%; text-align: center; }
  }
</style>

<div class="wrap" id="gateWrap">
  <div class="top"><img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo"></div>
  <h1 style="text-align:center;">Rehab Estimator Access</h1>
  <div class="subtitle" style="margin-bottom:16px;">Enter your phone number to unlock the calculator.</div>
  <div class="card">
    <div class="field">
      <label>Phone Number</label>
      <input id="gatePhone" type="tel" placeholder="(801) 555-1234" inputmode="tel">
    </div>
    <div class="field">
      <button type="button" class="btn" id="gateSubmitBtn">Unlock Estimator</button>
    </div>
    <div id="gateMessage" class="muted-small" style="margin-top:8px;min-height:18px;color:#b00020;text-align:center;font-size:0.85rem;"></div>
  </div>
  <div style="text-align:center;margin-top:12px;color:var(--muted);font-size:13px">For UTAH REIA members only. Need access? Contact us.</div>
</div>

<div id="rehab-widget">
  <div class="rw-header">
    <div class="rw-logo-area">
      <img src="https://assets.cdn.filesafe.space/DNirEjy0ejVwbHsaBYrn/media/682f680ec314718407baed82.png" alt="UTAH REIA logo">
      <h2>Repair Estimator</h2>
      <p>Project Cost Calculator</p>
    </div>
    <div class="rw-big-total">
      <span class="label">Total Estimate</span>
      <div class="value" id="disp-grand-total">$0.00</div>
    </div>
  </div>

  <div class="rw-dashboard">
    <div class="rw-scope-breakdown">
      <div class="rw-section-title">Estimate Breakdown</div>
      <div class="rw-scope-grid" id="scope-breakdown-grid"></div>
    </div>
    <div class="rw-rooms-breakdown">
      <div class="rw-section-title">Rooms (Manual)</div>
      <div id="rooms-container">
        <div class="rw-room-row"><span>Kitchen</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Bathrooms</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Bedrooms</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row"><span>Living Areas</span><input type="number" class="rw-room-input" placeholder="$0.00"></div>
        <div class="rw-room-row" style="border-top:1px solid #eee; padding-top:5px; margin-top:5px;">
          <span>TOTAL:</span><strong id="rooms-total-disp">$0.00</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="rw-ai-toolbar">
    <button class="rw-btn-ai" id="ai-openai-btn" style="background:linear-gradient(135deg,#10b981 0%,#2563eb 100%);">
      <span>ðŸ¤– AI Auto-Fill (OpenAI)</span>
    </button>
    <span style="font-size:0.8rem; color:#64748b; margin-left:auto;">*Powered by OpenAI</span>
  </div>

  <div class="rw-table-container">
    <table class="rw-table">
      <thead>
        <tr>
          <th style="width: 30%;">Description of Work</th>
          <th style="width: 10%; text-align:center;">Qty</th>
          <th style="text-align:right;">Labor <small>($/unit)</small></th>
          <th style="text-align:right;">Material <small>($/unit)</small></th>
          <th style="text-align:right;">Sub <small>($/unit)</small></th>
          <th style="text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody id="rw-main-tbody"></tbody>
    </table>
  </div>

  <div class="rw-actions">
    <button class="rw-btn btn-clear" onclick="app.reset()">Reset</button>
    <button class="rw-btn btn-print" onclick="window.print()">Print Estimate</button>
  </div>
  <div class="rw-footer">&copy; 2024 Repair Estimator Tool. All rights reserved.</div>
</div>

<script>
// --- GATE CONTROLLER ---
(function() {
  const GATE_KEY = 'utah_reia_access_token';
  const gateWrap = document.getElementById('gateWrap');
  const widget = document.getElementById('rehab-widget');
  const btn = document.getElementById('gateSubmitBtn');
  const phoneInput = document.getElementById('gatePhone');
  const msg = document.getElementById('gateMessage');

  if(localStorage.getItem(GATE_KEY) === 'unlocked') { unlock(); }

  btn.addEventListener('click', async function() {
    const phone = phoneInput.value.replace(/\D/g,'');
    msg.innerText = "";
    phoneInput.style.borderColor = "#cbd5e1";
    
    if(phone.length < 10) {
      msg.innerText = "Please enter a valid 10-digit phone number.";
      phoneInput.style.borderColor = "#b00020";
      return;
    }

    msg.innerText = "Verifying...";
    try {
      const response = await fetch('https://rehab-estimator-delta.vercel.app/api/verify-phone', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone })
      });
      const data = await response.json();
      if (data.valid) {
        localStorage.setItem(GATE_KEY, 'unlocked');
        msg.innerText = "";
        unlock();
      } else {
        msg.innerText = "Phone number not found. Access denied.";
        phoneInput.style.borderColor = "#b00020";
      }
    } catch (e) {
      // Demo fallback if API fails
      localStorage.setItem(GATE_KEY, 'unlocked');
      unlock();
    }
  });

  function unlock() {
    gateWrap.style.display = 'none';
    widget.style.display = 'block';
  }
})();

// --- CALCULATOR APP ---
const app = (function() {
  const STORAGE_KEY = 'ghl_est_data_v3';
  const categories = [
    "General Conditions", "Demolition", "Concrete & Flatwork", "Masonry", "Siding",
    "Roofing", "Ext. Doors & Windows", "Garage Doors", "Landscaping", "Framing & Drywall",
    "Cabinets & Countertops", "Doors & Trim", "Carpet & Resilient", "Hardwood Flooring",
    "Tiling", "Painting", "Appliances", "Plumbing", "HVAC", "Electrical", "Miscellaneous"
  ];

  /* * UTAH MARKET DATA (2024-2025 Estimates)
   * Format: [Labor $/Unit, Material $/Unit]
   * Logic: 
   * - Paint/Flooring: Per SqFt
   * - Trades (Plumbing/Elec): Lump Sum "Allowance" assuming Qty=1
   */

  const tbody = document.getElementById('rw-main-tbody');
  const scopeGrid = document.getElementById('scope-breakdown-grid');
  const grandTotalDisp = document.getElementById('disp-grand-total');
  const roomsInputs = document.querySelectorAll('.rw-room-input');
  const roomsTotalDisp = document.getElementById('rooms-total-disp');
  const aiSelect = document.getElementById('ai-level-select');

  function init() {
    buildTable();
    buildScopeGrid();
    loadData();
    attachListeners();
  }

  function buildTable() {
    tbody.innerHTML = '';
    categories.forEach((cat, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:600;">${cat}</td>
        <td style="text-align:center;"><input type="number" class="rw-inp rw-inp-qty" data-idx="${idx}" placeholder="0" data-cat="${cat}"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-l" data-idx="${idx}" placeholder="0.00"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-m" data-idx="${idx}" placeholder="0.00"></td>
        <td><input type="number" class="rw-inp rw-inp-money inp-s" data-idx="${idx}" placeholder="0.00"></td>
        <td class="rw-row-total" id="row-total-${idx}">$0.00</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function buildScopeGrid() {
    scopeGrid.innerHTML = '';
    categories.forEach((cat, idx) => {
      const div = document.createElement('div');
      div.className = 'rw-scope-item';
      div.innerHTML = `<span class="rw-scope-name">${cat}</span><span class="rw-scope-val" id="scope-val-${idx}">$0</span>`;
      scopeGrid.appendChild(div);
    });
  }


  function calculate() {
    let grandTotal = 0;
    categories.forEach((_, idx) => {
      const qty = getVal(`input.rw-inp-qty[data-idx="${idx}"]`);
      const l = getVal(`input.inp-l[data-idx="${idx}"]`);
      const m = getVal(`input.inp-m[data-idx="${idx}"]`);
      const s = getVal(`input.inp-s[data-idx="${idx}"]`);
      const rowSum = qty * (l + m + s);
      grandTotal += rowSum;
      document.getElementById(`row-total-${idx}`).innerText = fmt(rowSum);
      
      const scopeItem = document.getElementById(`scope-val-${idx}`);
      if(scopeItem) {
        scopeItem.innerText = fmt(rowSum, 0);
        scopeItem.style.color = rowSum > 0 ? '#0f172a' : '#cbd5e1';
      }
    });
    grandTotalDisp.innerText = fmt(grandTotal);
    
    let roomSum = 0;
    roomsInputs.forEach(inp => roomSum += parseFloat(inp.value) || 0);
    roomsTotalDisp.innerText = fmt(roomSum);
    
    saveData();
  }

  function getVal(selector) { const el = document.querySelector(selector); return el ? (parseFloat(el.value) || 0) : 0; }
  function fmt(num, decimals = 2) { return '$' + num.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }
  function attachListeners() { tbody.addEventListener('input', calculate); roomsInputs.forEach(i => i.addEventListener('input', calculate)); }
  
  function saveData() {
    const data = { rows: [], rooms: [] };
    categories.forEach((_, idx) => {
      data.rows.push({
        q: document.querySelector(`input.rw-inp-qty[data-idx="${idx}"]`).value,
        l: document.querySelector(`input.inp-l[data-idx="${idx}"]`).value,
        m: document.querySelector(`input.inp-m[data-idx="${idx}"]`).value,
        s: document.querySelector(`input.inp-s[data-idx="${idx}"]`).value
      });
    });
    roomsInputs.forEach(inp => data.rooms.push(inp.value));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const data = JSON.parse(raw);
      if (data.rows) {
        data.rows.forEach((row, idx) => {
          document.querySelector(`input.rw-inp-qty[data-idx="${idx}"]`).value = row.q;
          document.querySelector(`input.inp-l[data-idx="${idx}"]`).value = row.l;
          document.querySelector(`input.inp-m[data-idx="${idx}"]`).value = row.m;
          document.querySelector(`input.inp-s[data-idx="${idx}"]`).value = row.s;
        });
      }
      if (data.rooms) { data.rooms.forEach((val, idx) => { if (roomsInputs[idx]) roomsInputs[idx].value = val; }); }
      calculate();
    } catch (e) {}
  }

  function reset() {
    if(confirm('Clear all data?')) { 
      localStorage.removeItem(STORAGE_KEY); 
      document.querySelectorAll('#rehab-widget input').forEach(i => i.value = ''); 
      calculate(); 
    }
  }

  document.addEventListener('DOMContentLoaded', init);
  // --- AI OpenAI Integration ---
  async function applyOpenAIAI() {
    const btn = document.getElementById('ai-openai-btn');
    btn.disabled = true;
    btn.innerText = 'Thinking...';
    try {
      const categoriesList = categories;
      // Optionally, you can send more context (e.g., room counts, user notes)
      const context = '';
      const res = await fetch('https://rehab-estimator-delta.vercel.app/api/ai-pricing', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ categories: categoriesList, context })
      });
      const data = await res.json();
      if (data && data.prices) {
        categories.forEach((cat, idx) => {
          if (data.prices[cat]) {
            const lInput = document.querySelector(`input.inp-l[data-idx="${idx}"]`);
            const mInput = document.querySelector(`input.inp-m[data-idx="${idx}"]`);
            if (lInput && typeof data.prices[cat].labor === 'number') lInput.value = data.prices[cat].labor.toFixed(2);
            if (mInput && typeof data.prices[cat].material === 'number') mInput.value = data.prices[cat].material.toFixed(2);
          }
        });
        calculate();
      } else {
        alert('AI did not return valid prices.');
      }
    } catch (e) {
      alert('Failed to fetch AI prices.');
    }
    btn.disabled = false;
    btn.innerText = 'ðŸ¤– AI (OpenAI) Auto-Fill';
  }

  // Attach OpenAI AI button listener after DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('ai-openai-btn');
    if (btn) btn.addEventListener('click', applyOpenAIAI);
  });

  return { reset };
})();
</script>